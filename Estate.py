from web3 import Web3
from web3 import HTTPProvider
import web3.personal
import web3.contract
import web3.eth
import web3
import json
import time


class Estate:
    w3 = None
    contract = None
    user_address = None
    password = None
    contract_address = Web3.toChecksumAddress("0x8aa12ac2da22345b8c497dee095b95f2cccb4630")
    abi = "[{\"constant\":true,\"inputs\":[{\"name\":\"id\",\"type\":\"uint256\"}],\"name\":\"get_Estate\",\"outputs\":[{\"name\":\"\",\"type\":\"uint256\"},{\"name\":\"\",\"type\":\"address\"},{\"name\":\"\",\"type\":\"string\"},{\"name\":\"\",\"type\":\"bool\"},{\"name\":\"\",\"type\":\"uint256\"},{\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"name\":\"sale_numb\",\"type\":\"uint256\"}],\"name\":\"cancel_sale\",\"outputs\":[],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"name\":\"estate_id\",\"type\":\"uint256\"},{\"name\":\"address_to\",\"type\":\"address\"}],\"name\":\"send_present\",\"outputs\":[],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[],\"name\":\"check_to_bue\",\"outputs\":[{\"name\":\"\",\"type\":\"uint256\"}],\"payable\":true,\"stateMutability\":\"payable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"name\":\"present_numb\",\"type\":\"uint256\"}],\"name\":\"confirm_present\",\"outputs\":[],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"name\":\"estate_id\",\"type\":\"uint256\"},{\"name\":\"price\",\"type\":\"uint256\"},{\"name\":\"date\",\"type\":\"uint256\"}],\"name\":\"create_sale\",\"outputs\":[],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"name\":\"present_numb\",\"type\":\"uint256\"}],\"name\":\"cancel_present\",\"outputs\":[],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[{\"name\":\"id\",\"type\":\"uint256\"}],\"name\":\"get_Sale\",\"outputs\":[{\"name\":\"\",\"type\":\"uint256\"},{\"name\":\"\",\"type\":\"address\"},{\"name\":\"\",\"type\":\"uint256\"},{\"name\":\"\",\"type\":\"uint256\"},{\"name\":\"\",\"type\":\"address[]\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"name\":\"owner\",\"type\":\"address\"},{\"name\":\"info\",\"type\":\"string\"},{\"name\":\"pledge\",\"type\":\"bool\"},{\"name\":\"squere\",\"type\":\"uint256\"},{\"name\":\"useful_squere\",\"type\":\"uint256\"}],\"name\":\"add_estate\",\"outputs\":[],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"get_number_of_Estate\",\"outputs\":[{\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"name\":\"sale_numb\",\"type\":\"uint256\"}],\"name\":\"cancel_to_bue\",\"outputs\":[],\"payable\":false,\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"get_number_of_Sale\",\"outputs\":[{\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"reciver\",\"outputs\":[{\"name\":\"\",\"type\":\"address\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"balance\",\"outputs\":[{\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"get_number_of_Present\",\"outputs\":[{\"name\":\"\",\"type\":\"uint256\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[{\"name\":\"id\",\"type\":\"uint256\"}],\"name\":\"get_Present\",\"outputs\":[{\"name\":\"\",\"type\":\"uint256\"},{\"name\":\"\",\"type\":\"address\"},{\"name\":\"\",\"type\":\"address\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"admin\",\"outputs\":[{\"name\":\"\",\"type\":\"address\"}],\"payable\":false,\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"payable\":true,\"stateMutability\":\"payable\",\"type\":\"constructor\"},{\"payable\":true,\"stateMutability\":\"payable\",\"type\":\"fallback\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"name\":\"from\",\"type\":\"address\"},{\"indexed\":false,\"name\":\"to\",\"type\":\"address\"},{\"indexed\":false,\"name\":\"amount\",\"type\":\"uint256\"}],\"name\":\"Sent\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"name\":\"value\",\"type\":\"uint256\"}],\"name\":\"Receive\",\"type\":\"event\"}]"
    bin = "608060405273ca35b7d915458ef540ade6068dfe2f44e8fa733c6000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060006002556115d68061006c6000396000f3fe6080604052600436106100f1576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680630697000e1461012a5780630e9bb163146102315780631a26dbab1461026c57806327264a9c146102c75780633d53ce8a146102e55780633d68de2e146103205780635a4ab0631461036f5780635cdf9f71146103aa5780636a9879d81461048257806372650a951461058a5780637719fb12146105b55780637a5f67ca146105f0578063a4bbfb741461061b578063b69ef8a814610672578063c5bac7521461069d578063f1d7683d146106c8578063f851a4401461077d575b7f49b4c3f4344f33413322c03885f90f29e906bd8eb0cb2c3d815ee1ad2b3c989c346040518082815260200191505060405180910390a1005b34801561013657600080fd5b506101636004803603602081101561014d57600080fd5b81019080803590602001909291905050506107d4565b604051808781526020018673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018060200185151515158152602001848152602001838152602001828103825286818151815260200191508051906020019080838360005b838110156101f15780820151818401526020810190506101d6565b50505050905090810190601f16801561021e5780820380516001836020036101000a031916815260200191505b5097505050505050505060405180910390f35b34801561023d57600080fd5b5061026a6004803603602081101561025457600080fd5b8101908080359060200190929190505050610981565b005b34801561027857600080fd5b506102c56004803603604081101561028f57600080fd5b8101908080359060200190929190803573ffffffffffffffffffffffffffffffffffffffff1690602001909291905050506109f3565b005b6102cf610b81565b6040518082815260200191505060405180910390f35b3480156102f157600080fd5b5061031e6004803603602081101561030857600080fd5b8101908080359060200190929190505050610ba0565b005b34801561032c57600080fd5b5061036d6004803603606081101561034357600080fd5b81019080803590602001909291908035906020019092919080359060200190929190505050610d12565b005b34801561037b57600080fd5b506103a86004803603602081101561039257600080fd5b8101908080359060200190929190505050610e84565b005b3480156103b657600080fd5b506103e3600480360360208110156103cd57600080fd5b8101908080359060200190929190505050610f77565b604051808681526020018573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200184815260200183815260200180602001828103825283818151815260200191508051906020019060200280838360005b8381101561046a57808201518184015260208101905061044f565b50505050905001965050505050505060405180910390f35b34801561048e57600080fd5b50610588600480360360a08110156104a557600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803590602001906401000000008111156104e257600080fd5b8201836020820111156104f457600080fd5b8035906020019184600183028401116401000000008311171561051657600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f82011690508083019250505050505050919291929080351515906020019092919080359060200190929190803590602001909291905050506110de565b005b34801561059657600080fd5b5061059f611263565b6040518082815260200191505060405180910390f35b3480156105c157600080fd5b506105ee600480360360208110156105d857600080fd5b8101908080359060200190929190505050611270565b005b3480156105fc57600080fd5b506106056112f7565b6040518082815260200191505060405180910390f35b34801561062757600080fd5b50610630611304565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34801561067e57600080fd5b5061068761132a565b6040518082815260200191505060405180910390f35b3480156106a957600080fd5b506106b2611330565b6040518082815260200191505060405180910390f35b3480156106d457600080fd5b50610701600480360360208110156106eb57600080fd5b810190808035906020019092919050505061133d565b604051808481526020018373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001935050505060405180910390f35b34801561078957600080fd5b506107926113f2565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b600080606060008060006003878154811015156107ed57fe5b90600052602060002090600602016000015460038881548110151561080e57fe5b906000526020600020906006020160010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1660038981548110151561084f57fe5b906000526020600020906006020160020160038a81548110151561086f57fe5b906000526020600020906006020160030160009054906101000a900460ff1660038b81548110151561089d57fe5b90600052602060002090600602016004015460038c8154811015156108be57fe5b906000526020600020906006020160050154838054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156109655780601f1061093a57610100808354040283529160200191610965565b820191906000526020600020905b81548152906001019060200180831161094857829003601f168201915b5050505050935095509550955095509550955091939550919395565b60058181548110151561099057fe5b90600052602060002090600502016000808201600090556001820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff0219169055600282016000905560038201600090556004820160006109ee9190611417565b505050565b600382815481101515610a0257fe5b906000526020600020906006020160010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141515610a6d57600080fd5b60046060604051908101604052808481526020013373ffffffffffffffffffffffffffffffffffffffff1681526020018373ffffffffffffffffffffffffffffffffffffffff16815250908060018154018082558091505090600182039060005260206000209060030201600090919290919091506000820151816000015560208201518160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060408201518160020160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505050505050565b60003073ffffffffffffffffffffffffffffffffffffffff1631905090565b3373ffffffffffffffffffffffffffffffffffffffff16600482815481101515610bc657fe5b906000526020600020906003020160020160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16141515610c1a57600080fd5b336003600483815481101515610c2c57fe5b906000526020600020906003020160000154815481101515610c4a57fe5b906000526020600020906006020160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600481815481101515610ca857fe5b90600052602060002090600302016000808201600090556001820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff02191690556002820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff0219169055505050565b3373ffffffffffffffffffffffffffffffffffffffff16600384815481101515610d3857fe5b906000526020600020906006020160010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16141515610d8c57600080fd5b6060600560a0604051908101604052808681526020013373ffffffffffffffffffffffffffffffffffffffff16815260200185815260200184815260200183815250908060018154018082558091505090600182039060005260206000209060050201600090919290919091506000820151816000015560208201518160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060408201518160020155606082015181600301556080820151816004019080519060200190610e7a929190611438565b5050505050505050565b3373ffffffffffffffffffffffffffffffffffffffff16600482815481101515610eaa57fe5b906000526020600020906003020160010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16141515610efe57600080fd5b600481815481101515610f0d57fe5b90600052602060002090600302016000808201600090556001820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff02191690556002820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff0219169055505050565b6000806000806060600586815481101515610f8e57fe5b906000526020600020906005020160000154600587815481101515610faf57fe5b906000526020600020906005020160010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600588815481101515610ff057fe5b90600052602060002090600502016002015460058981548110151561101157fe5b90600052602060002090600502016003015460058a81548110151561103257fe5b9060005260206000209060050201600401808054806020026020016040519081016040528092919081815260200182805480156110c457602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001906001019080831161107a575b505050505090509450945094509450945091939590929450565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561113957600080fd5b60006003805490509050600360c0604051908101604052808381526020018873ffffffffffffffffffffffffffffffffffffffff168152602001878152602001861515815260200185815260200184815250908060018154018082558091505090600182039060005260206000209060060201600090919290919091506000820151816000015560208201518160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060408201518160020190805190602001906112239291906114c2565b5060608201518160030160006101000a81548160ff0219169083151502179055506080820151816004015560a08201518160050155505050505050505050565b6000600380549050905090565b60058181548110151561127f57fe5b90600052602060002090600502016004013390806001815401808255809150509060018203906000526020600020016000909192909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505050565b6000600580549050905090565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60025481565b6000600480549050905090565b600080600060048481548110151561135157fe5b90600052602060002090600302016000015460048581548110151561137257fe5b906000526020600020906003020160010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff166004868154811015156113b357fe5b906000526020600020906003020160020160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169250925092509193909250565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b50805460008255906000526020600020908101906114359190611542565b50565b8280548282559060005260206000209081019282156114b1579160200282015b828111156114b05782518260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555091602001919060010190611458565b5b5090506114be9190611567565b5090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061150357805160ff1916838001178555611531565b82800160010185558215611531579182015b82811115611530578251825591602001919060010190611515565b5b50905061153e9190611542565b5090565b61156491905b80821115611560576000816000905550600101611548565b5090565b90565b6115a791905b808211156115a357600081816101000a81549073ffffffffffffffffffffffffffffffffffffffff02191690555060010161156d565b5090565b9056fea165627a7a723058202a0a99ac228d0382df88cf4163d818e7b4d0dab886a5b6077306904b341bd73a0029"

    # Прописывать в провайдере ip на котором запущен geth
    def __init__(self):
        self.w3 = Web3(HTTPProvider("http://127.0.0.1:8545"))
        self.contract = self.w3.eth.contract(address=self.contract_address, abi=self.abi)

    def auth(self, user, passfrase):
        '''
        :param user_:
        :param password:
        :return: True / False
        '''
        try:
            self.user_address = Web3.toChecksumAddress(user)
            self.password = passfrase
            log = web3.personal.Personal(self.w3).unlockAccount(self.user_address
                                                                , passfrase)
        except Exception:
            return False
        return log
    '''
    Моя недвижимость ()
        Парсим все базу, находим только нужные поля
        Вывод (инт - идентификатор
                строка - адрес,
                бул - залог,
                инт - общ.площадь,
                инт - полезная площадь)
    '''
    def get_estate(self):
        '''
        :return: [[], [], ... ,[]]
        '''
        list_of_estates = []
        number = 5
        web3.personal.Personal(self.w3).unlockAccount(self.user_address, self.password)
        # number = self.contract.function.get_number_of_all().call()
        for i in range(number):
            # проверять на нулевые строки
            answer = self.contract.functions.get_Estate(i).call()
            for id in range(len(answer)):
                answer[id] = str(answer[id])
            list_of_estates.append(answer)
            answer = ''
        return list_of_estates

    '''
    Что можем подарить (логин)
        вызов Моя недвижимость
        Вывод (адрес)

    Подарить(ид_имущества, адрес получателя)
        Создается объявление о дарении
        Вывод (строка "Успешно добавлено")

    Отменить подарок (ид_подарка)
        Удалить данные из структуре "Подарки"

    Подтвердить подарок ()
    '''

